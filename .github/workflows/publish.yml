name: Publish to Maven Central (manual or v* tags on main)

on:
  # 수동 실행 허용
  workflow_dispatch: {}
  # v* 태그 푸시 시 자동 실행 (예: v0.1.0)
  push:
    tags:
      - 'v*'

concurrency:
  group: release-central
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 태그가 main 히스토리 위인지 확인 (아니면 중립 스킵)
      - name: Ensure tag commit is on main history
        if: ${{ github.event_name == 'push' }}
        shell: bash
        run: |
          TAG_SHA="${GITHUB_SHA}"
          git fetch origin main --quiet
          if git merge-base --is-ancestor origin/main "$TAG_SHA"; then
            echo "✅ Tag commit is on main history."
          else
            echo "⏭️ Tag commit is NOT on main. Skipping."
            exit 78 # neutral
          fi

      - name: Set up Temurin JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle

      # (선택) Gradle Wrapper 검증
      # - uses: gradle/actions/wrapper-validation@v3

      - name: Publish (upload + validate only; portal Publish is manual)
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.CENTRAL_TOKEN_USER }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.CENTRAL_TOKEN_PASS }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_PRIVATE_KEY_ARMOR }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.GPG_PASSPHRASE }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.GPG_KEY_ID }}
        run: ./gradlew publishToMavenCentral --no-daemon
